{% extends 'docs/base_docs.html' %}
{% block title %} PostgreSQL {% endblock %}

{% block doc_content %}
{% include 'docs/postgresql/sub_nav.html' %}
<h1 class="doc-title">GROUP BY AND HAVING</h1>
<section class="doc-section">

  <h3 class="doc-subheader">group by는 aggregate functions (COUNT(), MAX(), MIN(), SUM(), AVG()) 과 합께 사용</h3>
  <pre><code class="language-sql">SELECT column_name(s) FROM table_name
    WHERE condition
    GROUP BY column_name(s) ORDER BY column_name(s); </code></pre>
    
  <h2 class="doc-header">GROUP BY</h2>
  <pre><code class="language-sql">SELECT COUNT(id), country FROM customer
    GROUP BY country ORDER BY COUNT(id) DESC;</code></pre>
  <pre><code class="language-sql">SELECT Shippers.ShipperName, COUNT(Orders.OrderID) AS NumberOfOrders 
    FROM Orders
    LEFT JOIN Shippers ON Orders.ShipperID = Shippers.ShipperID
    GROUP BY ShipperName;</code></pre>
  <pre><code class="language-sql">-- 출고된 연도 별로 가격의 합
    -- COUNT, MAX, MIN, AVG 등도 사용 가능
  SELECT SUM(price), model_year FROM car GROUP BY model_year; 
  SELECT SUM(price), customer_id FROM car GROUP BY customer_id; </code></pre>  
  
  <h2 class="doc-header">HAVING</h2>
  <h3 class="doc-subheader">group by 하면 where을 사용할 수 없어 HAVING 을 사용.</h3>
  <pre><code class="language-sql">SELECT column_name(s) FROM table_name
    WHERE condition
    GROUP BY column_name(s)
    HAVING condition ORDER BY column_name(s);</code></pre>
  <pre><code class="language-sql">SELECT COUNT(id), Country FROM Customer
    GROUP BY Country
    HAVING COUNT(id) &gt; 15;</code></pre>
  <pre><code class="language-sql">SELECT Employees.LastName, COUNT(Orders.OrderID) AS NumberOfOrders
  FROM (Orders INNER JOIN Employees ON Orders.EmployeeID = Employees.EmployeeID)
  GROUP BY LastName
  HAVING COUNT(Orders.OrderID) &gt; 10;</code></pre>
  <pre><code class="language-sql">SELECT Employees.LastName, COUNT(Orders.OrderID) AS NumberOfOrders
  FROM Orders
  INNER JOIN Employees ON Orders.EmployeeID = Employees.EmployeeID
  WHERE LastName = 'Davolio' OR LastName = 'Fuller'
  GROUP BY LastName
  HAVING COUNT(Orders.OrderID) &gt; 25;</code></pre>
  <pre><code class="language-sql">SELECT COUNT(*) , model FROM car
    GROUP BY model 
    HAVING COUNT(*) {`>`} 1 
    ORDER BY COUNT(*) DESC;</code></pre>
  
      <!-- ############## distinct #########################--> 
  <h2 class="doc-header">SELECT DISTINCT; 중복제거</h2>
    <pre><code class="language-sql">SELECT DISTINCT column1, column2 FROM table_name;
  SELECT Count(DISTINCT column1) FROM table_name;</code></pre>
  <pre><code class="language-sql">SELECT country, COUNT(DISTINCT city) FROM customers
    GROUP BY country; -- 중복되지 않는 CITY의 개수를 샘</code></pre>
  
  <h2 class="doc-header">중복된 모델을 가진 자동차를 삭제</h2>
  <pre><code class="language-sql">DELETE c1
    FROM car c1
    JOIN car c2
    ON c1.model = c2.model
    WHERE c1.id &lt; c2.id;
    -- OR, WHERE c1.id &lt; (c2.id + 3); -- 3개만 남기기 </code></pre>
  <pre><code class="language-sql">-- 중복 제거 make, model, model_year 조합
  DELETE FROM car 
  WHERE id NOT IN (SELECT MIN(id) FROM car GROUP BY make, model, model_year);</code></pre>
  
  <h2 class="doc-header">ROLLUP : GROUP BY 이후에 다시 전체 내용을 더하는 방식 </h2>
  <pre><code class="language-sql">SELECT make, SUM(price) AS total_price FROM car  
  GROUP BY make WITH ROLLUP;
  SELECT make, COUNT(id) AS total_price FROM car  
  GROUP BY make WITH ROLLUP;  </code></pre>
</section>
{% endblock %}